rarefaction(., method = "SBR")
SBR_PT <- round_macro %>%
filter(site == "PT") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "SBR")
SBR_EV <- round_macro %>%
filter(site == "EV") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "SBR")
SBR_TL <- round_macro %>%
filter(site == "TL") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "SBR")
SBR_MR <- round_macro %>%
filter(site == "MR") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "SBR")
rarefaction_macro <- rbind(
data.frame(site = rep("MD", length(SBR_MD)), sample = 1:length(SBR_MD), species_richness = SBR_MD),
data.frame(site = rep("JC", length(SBR_JC)), sample = 1:length(SBR_JC), species_richness = SBR_JC),
data.frame(site = rep("PT", length(SBR_PT)), sample = 1:length(SBR_PT), species_richness = SBR_PT),
data.frame(site = rep("EV", length(SBR_EV)), sample = 1:length(SBR_EV), species_richness = SBR_EV),
data.frame(site = rep("TL", length(SBR_TL)), sample = 1:length(SBR_TL), species_richness = SBR_TL),
data.frame(site = rep("MR", length(SBR_MR)), sample = 1:length(SBR_MR), species_richness = SBR_MR)
)
# sSBR Macroinvertebrates
sSBR_MD <- round_macro %>%
filter(site == "MD") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "sSBR", latlong = T, coords = environ_vars[which(environ_vars$site == "MD"), c("local_x", "local_y")])
sSBR_JC <- round_macro %>%
filter(site == "JC") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "sSBR", latlong = T, coords = environ_vars[which(environ_vars$site == "JC"), c("local_x", "local_y")])
sSBR_PT <- round_macro %>%
filter(site == "PT") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "sSBR", latlong = T, coords = environ_vars[which(environ_vars$site == "PT"), c("local_x", "local_y")])
sSBR_EV <- round_macro %>%
filter(site == "EV") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "sSBR", latlong = T, coords = environ_vars[which(environ_vars$site == "EV"), c("local_x", "local_y")])
sSBR_TL <- round_macro %>%
filter(site == "TL") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "sSBR", latlong = T, coords = environ_vars[which(environ_vars$site == "TL"), c("local_x", "local_y")])
sSBR_MR <- round_macro %>%
filter(site == "MR") %>%
select(-c(sample_code:year)) %>%
rarefaction(., method = "sSBR", latlong = T, coords = environ_vars[which(environ_vars$site == "MR"), c("local_x", "local_y")])
sSBR_macro <- rbind(
data.frame(site = rep("MD", length(sSBR_MD)), sample = 1:length(sSBR_MD), species_richness = sSBR_MD),
data.frame(site = rep("JC", length(sSBR_JC)), sample = 1:length(sSBR_JC), species_richness = sSBR_JC),
data.frame(site = rep("PT", length(sSBR_PT)), sample = 1:length(sSBR_PT), species_richness = sSBR_PT),
data.frame(site = rep("EV", length(sSBR_EV)), sample = 1:length(sSBR_EV), species_richness = sSBR_EV),
data.frame(site = rep("TL", length(sSBR_TL)), sample = 1:length(sSBR_TL), species_richness = sSBR_TL),
data.frame(site = rep("MR", length(sSBR_MR)), sample = 1:length(sSBR_MR), species_richness = sSBR_MR)
)
# Merge SBR and sSBR
rarefaction_macro$method <- "SBR"
sSBR_macro$method <- "sSBR"
rarefaction_macro <- rbind(rarefaction_macro, sSBR_macro)
# Merge rarefactions of all  trophic groups into one table
# set and order factor levels
rarefaction_all$site <- factor(rarefaction_all$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
rarefaction_bact$site <- factor(rarefaction_bact$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
#rarefaction_fungi$site <- factor(rarefaction_fungi$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
rarefaction_phyto$site <- factor(rarefaction_phyto$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
rarefaction_zoo$site <- factor(rarefaction_zoo$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
rarefaction_macro$site <- factor(rarefaction_macro$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
# add group column to all
rarefaction_all$group <- "Whole-community"
rarefaction_bact$group <- "Bacteria"
#rarefaction_fungi$group <- "Fungi"
rarefaction_phyto$group <- "Phytoplankton"
rarefaction_zoo$group <- "Zooplankton"
rarefaction_macro$group <- "Macroinvertebrates"
# combine data.frames into one
rarefaction_df <- rbind(rarefaction_all, rarefaction_bact,
#rarefaction_fungi,
rarefaction_phyto, rarefaction_zoo, rarefaction_macro)
# set and order factor levels
rarefaction_df$site <- factor(rarefaction_df$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
rarefaction_df$group <- factor(rarefaction_df$group, levels = group_labels)
# ==============================================================================
# Function: compute_mobr_div()
# Purpose:
#   Compute alpha-, beta-, and gamma-diversity using the MOBR framework
#   for a given community matrix (bacteria, phytoplankton, zooplankton,
#   macroinvertebrates, or whole-community).
#
# Assumptions:
#   - comm_matrix has columns: sample_code, sample_code_short (optional),
#     site, year, and then species columns (numeric).
#   - factors has at least: sample_code, site, year (and optionally sample_code_short).
# ==============================================================================
compute_mobr_div <- function(comm_matrix, factors, environmental_data,
indices = c("N", "S", "S_n", "S_PIE"),
effort = 20) {
#### 1. Prepare data --------------------------------------------------------
# Remove metadata columns from the community matrix by name (robust)
species_mat <- comm_matrix %>%
dplyr::select(-dplyr::any_of(c("sample_code",
"sample_code_short",
"site",
"year")))
# Ensure integer counts for MOBR
comm_df_round <- species_mat %>%
ceiling() %>%
as.data.frame()
# Add sample metadata (sample_code, site, year, ...)
comm_df_round <- dplyr::bind_cols(factors, comm_df_round)
# Ensure sample order matches environmental_data (where possible)
comm_df_round <- comm_df_round[
match(environmental_data$sample_code, comm_df_round$sample_code),
]
# Drop rows that didn't match (if any)
comm_df_round <- comm_df_round %>%
dplyr::filter(!is.na(sample_code))
# Convert to factors for grouping
comm_df_round$site <- factor(comm_df_round$site)
comm_df_round$year <- factor(comm_df_round$year)
#### 2. Run MOBR (site × year) ----------------------------------------------
# We compute diversity per site × year (Option A)
SBR <- comm_df_round %>%
dplyr::group_by(site, year) %>%
dplyr::group_modify(~ mobr::calc_comm_div(
.x %>% dplyr::select(where(is.numeric)),  # only species columns
index  = indices,
effort = effort
)) %>%
dplyr::ungroup()
#### 3. Alpha (sample-level) ------------------------------------------------
# MOBR outputs alpha rows in the order of samples within each site-year.
alpha_df <- SBR %>%
dplyr::filter(index == "S", scale == "alpha") %>%
dplyr::group_by(site, year) %>%
dplyr::mutate(row_id = dplyr::row_number()) %>%
dplyr::ungroup()
# Attach row indices inside each site-year for matching
comm_df_round2 <- comm_df_round %>%
dplyr::group_by(site, year) %>%
dplyr::mutate(row_id = dplyr::row_number()) %>%
dplyr::ungroup()
# Match alpha diversity back to each sample
all_alpha <- comm_df_round2 %>%
dplyr::select(sample_code, site, year, row_id) %>%
dplyr::left_join(
alpha_df %>%
dplyr::select(site, year, row_id, all_alpha = value),
by = c("site", "year", "row_id")
) %>%
dplyr::select(-row_id)
#### 4. Beta_S_n (site-year level, repeated to samples) ---------------------
all_beta <- SBR %>%
dplyr::filter(index == "beta_S_n", scale == "beta") %>%
dplyr::select(site, year, all_beta = value)
all_beta_samples <- comm_df_round %>%
dplyr::select(sample_code, site, year) %>%
dplyr::left_join(all_beta, by = c("site", "year"))
#### 5. Gamma (site-year level, repeated to samples) ------------------------
all_gamma <- SBR %>%
dplyr::filter(index == "S", scale == "gamma") %>%
dplyr::select(site, year, all_gamma = value)
all_gamma_samples <- comm_df_round %>%
dplyr::select(sample_code, site, year) %>%
dplyr::left_join(all_gamma, by = c("site", "year"))
#### 6. Full table (site-year level) ----------------------------------------
full_table <- all_alpha %>%
dplyr::left_join(all_beta,  by = c("site", "year")) %>%
dplyr::left_join(all_gamma, by = c("site", "year"))
#### 7. Outputs -------------------------------------------------------------
list(
alpha_samples = all_alpha,        # sample-level alpha
beta_samples  = all_beta_samples, # sample-level beta_S_n
gamma_samples = all_gamma_samples,# sample-level gamma
alpha_site    = all_alpha,        # site-year alpha (same as sample-level but can be summarised)
beta_site     = all_beta,         # site-year beta_S_n
gamma_site    = all_gamma,        # site-year gamma S
full_table    = full_table,       # site-year table (alpha, beta, gamma)
SBR           = SBR               # raw mobr output
)
}
# ==============================================================================
# rename_div()
# Purpose:
#   Standardize column names for a trophic group by adding a prefix
#   (e.g., "bact_alpha", "zoo_beta", "macro_gamma").
# ==============================================================================
rename_div <- function(div_obj, prefix) {
div_obj$full_table %>%
dplyr::select(sample_code, site, year,
all_alpha, all_beta, all_gamma) %>%
dplyr::rename(
!!paste0(prefix, "_alpha") := all_alpha,
!!paste0(prefix, "_beta")  := all_beta,
!!paste0(prefix, "_gamma") := all_gamma
)
}
# Run for each group -----------------------------------------------------------
bact_div  <- compute_mobr_div(bact_df,  factors, environmental_data)
phyto_div <- compute_mobr_div(phyto_df, factors, environmental_data)
zoo_div   <- compute_mobr_div(zoo_df,   factors, environmental_data)
macro_div <- compute_mobr_div(macro_df, factors, environmental_data)
whole_div <- compute_mobr_div(comm_df,  factors, environmental_data)
all_div    <- rename_div(whole_div, "all")
bact_div2  <- rename_div(bact_div,  "bact")
phyto_div2 <- rename_div(phyto_div, "phyto")
zoo_div2   <- rename_div(zoo_div,   "zoo")
macro_div2 <- rename_div(macro_div, "macro")
div_df <- all_div %>%
dplyr::left_join(bact_div2,  by = c("sample_code", "site", "year")) %>%
dplyr::left_join(phyto_div2, by = c("sample_code", "site", "year")) %>%
dplyr::left_join(zoo_div2,   by = c("sample_code", "site", "year")) %>%
dplyr::left_join(macro_div2, by = c("sample_code", "site", "year"))
div_env_df <- div_df %>%
left_join(environmental_data,
by = c("sample_code", "site", "year"))
# ------------------------------------------------------------------------------
# Helper function to convert a trophic group's diversity output (alpha, beta,
# gamma) into long format. This keeps reproducibility high and avoids
# manually generating 15 separate objects (alpha/beta/gamma for each group).
#
# Arguments:
#   div_obj     = output list from compute_mobr_div() for a given trophic group
#   group_name  = character name of the trophic group (e.g., "Bacteria")
#
# Output:
#   A long-format data frame with columns:
#     sample_code | site | year | diversity | scale | group
#
# This function automatically extracts alpha, beta, and gamma diversity,
# tags them with the correct scale and group label, and binds them together.
# ------------------------------------------------------------------------------
make_long <- function(div_obj, group_name) {
# ---- Alpha diversity (sample-level) ---------------------------------------
alpha <- div_obj$alpha_samples %>%
transmute(
sample_code, site, year,
diversity = all_alpha,     # numeric alpha-div value
scale = "alpha",           # identifies the scale
group = group_name         # identifies the trophic group
)
# ---- Beta diversity (sample-level, repeated from site-level) --------------
beta <- div_obj$beta_samples %>%
transmute(
sample_code, site, year,
diversity = all_beta,
scale = "beta",
group = group_name
)
# ---- Gamma diversity (sample-level, repeated from site-level) -------------
gamma <- div_obj$gamma_samples %>%
transmute(
sample_code, site, year,
diversity = all_gamma,
scale = "gamma",
group = group_name
)
# ---- Combine alpha, beta, and gamma into long format ----------------------
bind_rows(alpha, beta, gamma)
}
div_2016 <- div_df %>% # data frame for 2016
filter(year == "2016")
div_2017 <- div_df %>% # data frame for 2017
filter(year == "2017")
div_2018 <- div_df %>% # data frame for 2018
filter(year == "2018")
mean_sample_code <- gsub(pattern = "_16_", replacement = "_Mean_", div_2016$sample_code, ignore.case = FALSE, perl = FALSE, fixed = FALSE, useBytes = FALSE)
div_mean_temporary <- (div_2016[, -c(1:3)] + div_2017[, -c(1:3)] + div_2018[, -c(1:3)])/3 # estimate diversities' average of three years
div_mean_df <- data_frame(site = div_2016$site, # new data frame
year = "Mean", # set Mean as year
sample_code = mean_sample_code
)
div_mean_df <- cbind(div_mean_df, div_mean_temporary) # combine factors with diversities average
div_df <- rbind(div_df, div_mean_df) # add Mean to original diversities' data frame
# ------------------------------------------------------------------------------
# Convert all trophic groups into long format using the helper function
# ------------------------------------------------------------------------------
all_long   <- make_long(whole_div, "Whole-community")
bact_long  <- make_long(bact_div,  "Bacteria")
phyto_long <- make_long(phyto_div, "Phytoplankton")
zoo_long   <- make_long(zoo_div,   "Zooplankton")
macro_long <- make_long(macro_div, "Macroinvertebrates")
# ------------------------------------------------------------------------------
# Combine all trophic groups into a single long-format diversity table
# This replaces the previous massive rbind() block and prevents misalignment.
# ------------------------------------------------------------------------------
div_df_2 <- bind_rows(
all_long,
bact_long,
phyto_long,
zoo_long,
macro_long
)
# ------------------------------------------------------------------------------
# Add Mean rows (from wide div_df) into the long-format table
# ------------------------------------------------------------------------------
mean_rows <- div_df %>%
filter(year == "Mean")
mean_long <- mean_rows %>%
pivot_longer(
cols = ends_with(c("_alpha", "_beta", "_gamma")),
names_to = c("group_code", "scale"),
names_sep = "_",
values_to = "diversity"
) %>%
mutate(
group = recode(group_code,
all = "Whole-community",
bact = "Bacteria",
phyto = "Phytoplankton",
zoo = "Zooplankton",
macro = "Macroinvertebrates")
) %>%
select(sample_code, site, year, diversity, scale, group)
# Append to div_df_2
div_df_2 <- bind_rows(div_df_2, mean_long)
# ------------------------------------------------------------------------------
# Merge diversity table with environmental metadata
# Ensures each diversity entry is linked to its environmental context
# ------------------------------------------------------------------------------
div_env_df_2 <- div_df_2 %>%
left_join(environmental_data, by = c("sample_code", "site", "year"))
# Final output (kept for backward compatibility)
div_env_df <- div_env_df_2
env_2016 <- environmental_data %>% # data frame for 2016
filter(year == "2016")
env_2017 <- environmental_data %>% # data frame for 2017
filter(year == "2017")
env_2018 <- environmental_data %>% # data frame for 2018
filter(year == "2018")
### Estimate est_temp, TP and TN average per site in each year
MD_2016 <- env_2016 %>%
filter(site == "MD") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
JC_2016 <- env_2016 %>%
filter(site == "JC") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
PT_2016 <- env_2016 %>%
filter(site == "PT") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
EV_2016 <- env_2016 %>%
filter(site == "EV") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
TL_2016 <- env_2016 %>%
filter(site == "TL") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
MR_2016 <- env_2016 %>%
filter(site == "MR") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
env_2016 <- rbind(MD_2016, JC_2016, PT_2016, EV_2016, TL_2016, MR_2016)
MD_2017 <- env_2017 %>%
filter(site == "MD") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
JC_2017 <- env_2017 %>%
filter(site == "JC") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
PT_2017 <- env_2017 %>%
filter(site == "PT") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
EV_2017 <- env_2017 %>%
filter(site == "EV") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
TL_2017 <- env_2017 %>%
filter(site == "TL") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
MR_2017 <- env_2017 %>%
filter(site == "MR") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
env_2017 <- rbind(MD_2017, JC_2017, PT_2017, EV_2017, TL_2017, MR_2017)
MD_2018 <- env_2018 %>%
filter(site == "MD") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
JC_2018 <- env_2018 %>%
filter(site == "JC") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
PT_2018 <- env_2018 %>%
filter(site == "PT") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
EV_2018 <- env_2018 %>%
filter(site == "EV") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
TL_2018 <- env_2018 %>%
filter(site == "TL") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
MR_2018 <- env_2018 %>%
filter(site == "MR") %>%
mutate(Tmean_est_mean = mean(est_mean_temp_12M),
TP_mean = mean(phosphorus),
TN_mean = mean(nitrogen))
env_2018 <- rbind(MD_2018, JC_2018, PT_2018, EV_2018, TL_2018, MR_2018)
env_mean_temporary <- (env_2016[, -c(1:3)] + env_2017[, -c(1:3)] + env_2018[, -c(1:3)])/3 # estimate environmental data average of three years
env_mean_df <- data_frame(site = env_2016$site, # new data frame
year = "Mean", # set Mean as year
sample_code = mean_sample_code
)
env_mean_df <- cbind(env_mean_df, env_mean_temporary) # combine factors with environmental data average
## 1) Automatically collect all lake-year environmental datasets
#
## Identify objects in your environment matching the pattern "LAKE_YYYY"
#lake_objs <- ls(pattern = "^(MD|JC|PT|EV|TL|MR)_20(16|17|18)$")
#
## Extract all these objects into a named list
#env_list <- mget(lake_objs)
#
## Bind all lake-year data frames together
#env_extra <- bind_rows(env_list) %>%
#  # Keep only the columns we need (add more if required)
#  select(sample_code, site, year,
#         Tmean_est_mean, TP_mean, TN_mean)
#
## 2) Add the "Mean" environmental columns
## add Tmean_est_mean, TP_mean, TN_mean to environmental_data
#environmental_data <- environmental_data %>%
#  left_join(env_extra,
#            by = c("sample_code", "site", "year"))
#
## 3) Merge these environmental variables into environmental_data
#environmental_data <- bind_rows(environmental_data, env_mean_df)
# OLD CODE:
# Add est_temp, TP_mean and TN_mean columns to original env data frame
Tmean_est_mean <- c(MD_2016$Tmean_est_mean, MD_2017$Tmean_est_mean, MD_2018$Tmean_est_mean,
JC_2016$Tmean_est_mean, JC_2017$Tmean_est_mean, JC_2018$Tmean_est_mean,
PT_2016$Tmean_est_mean, PT_2017$Tmean_est_mean, PT_2018$Tmean_est_mean,
EV_2016$Tmean_est_mean, EV_2017$Tmean_est_mean, EV_2018$Tmean_est_mean,
TL_2016$Tmean_est_mean, TL_2017$Tmean_est_mean, TL_2018$Tmean_est_mean,
MR_2016$Tmean_est_mean, MR_2017$Tmean_est_mean, MR_2018$Tmean_est_mean)
TP_mean <- c(MD_2016$TP_mean, MD_2017$TP_mean, MD_2018$TP_mean,
JC_2016$TP_mean, JC_2017$TP_mean, JC_2018$TP_mean,
PT_2016$TP_mean, PT_2017$TP_mean, PT_2018$TP_mean,
EV_2016$TP_mean, EV_2017$TP_mean, EV_2018$TP_mean,
TL_2016$TP_mean, TL_2017$TP_mean, TL_2018$TP_mean,
MR_2016$TP_mean, MR_2017$TP_mean, MR_2018$TP_mean)
TN_mean <- c(MD_2016$TN_mean, MD_2017$TN_mean, MD_2018$TN_mean,
JC_2016$TN_mean, JC_2017$TN_mean, JC_2018$TN_mean,
PT_2016$TN_mean, PT_2017$TN_mean, PT_2018$TN_mean,
EV_2016$TN_mean, EV_2017$TN_mean, EV_2018$TN_mean,
TL_2016$TN_mean, TL_2017$TN_mean, TL_2018$TN_mean,
MR_2016$TN_mean, MR_2017$TN_mean, MR_2018$TN_mean)
environmental_data$Tmean_est_mean <- Tmean_est_mean
environmental_data$TP_mean <- TP_mean
environmental_data$TN_mean <- TN_mean
# combine data frames, means and years
environmental_data <- rbind(environmental_data, env_mean_df) # add Mean to original environmental data frame
# 4) Merge environmental data into your final diversity–environment table
div_env_df <- div_df_2 %>%
left_join(environmental_data,
by = c("sample_code", "site", "year"))
# set and order factor levels
div_env_df$site <- factor(div_env_df$site, levels = c("MD", "JC", "PT", "EV", "TL", "MR"))
div_env_df$year <- factor(div_env_df$year, levels = c("Mean", "2016", "2017", "2018"))
div_env_df$group <- factor(div_env_df$group, levels = group_levels)
# reorder data frames
div_env_df <- div_env_df %>%
select(site, year, sample_code, group, scale, everything())
# isolate each MOBR scale so rows align before computing ratios
alpha_div <- div_env_df %>%
filter(scale == "alpha") %>% # local richness per sample
arrange(site, year, sample_code, group) # ensure deterministic ordering
gamma_div <- div_env_df %>%
filter(scale == "gamma") %>% # regional richness per site
arrange(site, year, sample_code, group)
beta_sn_div <- div_env_df %>%
filter(scale == "beta") %>% # sample-based rarefaction beta
arrange(site, year, sample_code, group)
# classical beta (γ/α) for rows sharing the same metadata as alpha_div
beta_div <- data_frame(site = alpha_div$site,
year = alpha_div$year,
sample_code = alpha_div$sample_code,
group = alpha_div$group,
scale = "beta2",
diversity = gamma_div$diversity/alpha_div$diversity)
# bring along environmental covariates and traits from alpha_div
beta_div[ , 7:ncol(alpha_div)] <- alpha_div[ , 7:ncol(alpha_div)]
# bind all scales so downstream plots can facet on `scale`
div_env_df <- rbind(alpha_div, gamma_div, beta_sn_div, beta_div)
save(rarefaction_df, div_env_df, file = "../inputs/data_metrics.RData")
